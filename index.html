<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ピアノ教室予約管理システム</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        .time-slot {
            min-height: 40px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
        }
        .time-slot:hover {
            background-color: #f3f4f6;
        }
        .time-slot.available {
            background-color: #dcfce7;
            border-color: #16a34a;
        }
        .time-slot.unavailable {
            background-color: #fecaca;
            border-color: #dc2626;
        }
        .time-slot.booked {
            background-color: #dbeafe;
            border-color: #2563eb;
        }
        .fc-event {
            border: none !important;
            background: linear-gradient(45deg, #3b82f6, #1d4ed8) !important;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block !important;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .loading.hidden {
            display: none;
        }
        @media print {
            .page {
                display: block !important;
                page-break-before: always;
            }
            .page:first-child {
                page-break-before: avoid;
            }
        }
        
        /* 予約カレンダーのイベントを30分枠にぴったり収める */
        .fc-timegrid-event {
            /* 30分枠の高さにぴったり合わせる */
            inset: 0 !important;
            height: calc(100% - 1px) !important;
            font-size: 11px !important;
            padding: 2px 4px !important;
            overflow: hidden;
            margin: 0 !important;
        }

        /* イベントの内容を中央揃え */
        .fc-event-main {
            display: flex;
            align-items: center;
            height: 100%;
        }

        /* タイトルをシンプルに（はみ出したら省略） */
        .fc-event-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }

        /* 承認待ちカレンダー専用のスタイル */
        #pendingCalendar .fc-timegrid-event {
            cursor: pointer;
            transition: transform 0.2s;
        }

        #pendingCalendar .fc-timegrid-event:hover {
            transform: scale(1.05);
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-gray-600">読み込み中...</p>
        </div>
    </div>

    <!-- Firebase Config Alert -->
    <div id="firebaseConfigAlert" class="hidden fixed top-20 left-4 right-4 bg-yellow-100 border-l-4 border-yellow-500 p-4 z-50">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-yellow-500"></i>
            </div>
            <div class="ml-3">
                <p class="text-sm text-yellow-700">
                    Firebaseの設定が必要です。コード内の firebaseConfig を置き換えてください。
                </p>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-blue-600 text-white p-4 fixed top-0 left-0 right-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center">
                <i class="fas fa-music mr-2"></i>
                ピアノ教室予約システム
            </h1>
            <div class="space-x-4">
                <button type="button" onclick="showPage('home')" class="hover:bg-blue-700 px-3 py-2 rounded">
                    <i class="fas fa-home mr-1"></i>ホーム
                </button>
                <button type="button" onclick="showPage('student-register')" class="hover:bg-blue-700 px-3 py-2 rounded">
                    <i class="fas fa-user-plus mr-1"></i>生徒登録
                </button>
                <button type="button" onclick="showPage('teacher-login')" class="hover:bg-blue-700 px-3 py-2 rounded">
                    <i class="fas fa-chalkboard-teacher mr-1"></i>講師ログイン
                </button>
                <button type="button" onclick="showPage('student-login')" class="hover:bg-blue-700 px-3 py-2 rounded">
                    <i class="fas fa-sign-in-alt mr-1"></i>生徒ログイン
                </button>
            </div>
        </div>
    </nav>

    <!-- Home Page -->
    <div id="home" class="page mt-24">
        <div class="container mx-auto max-w-4xl px-4">
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold text-gray-800 mb-4">ピアノ教室予約管理システム</h1>
                <p class="text-xl text-gray-600 mb-8">個人運営ピアノ教室の完全予約管理システム</p>
                <div id="connectionStatus" class="inline-block px-4 py-2 rounded-full text-sm">
                    <i class="fas fa-circle mr-2"></i>
                    <span id="connectionText">接続確認中...</span>
                </div>
            </div>

            <div class="grid md:grid-cols-3 gap-6 mb-12">
                <div class="bg-white p-6 rounded-lg shadow-md text-center">
                    <i class="fas fa-user-plus text-4xl text-blue-500 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-3">生徒登録</h3>
                    <p class="text-gray-600 mb-4">年1回の希望時間提出で自動スケジュール決定</p>
                    <button type="button" onclick="showPage('student-register')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        登録画面
                    </button>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md text-center">
                    <i class="fas fa-chalkboard-teacher text-4xl text-green-500 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-3">講師管理</h3>
                    <p class="text-gray-600 mb-4">稼働時間設定・予約状況確認・申請管理</p>
                    <button type="button" onclick="showPage('teacher-login')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        管理画面
                    </button>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md text-center">
                    <i class="fas fa-calendar-check text-4xl text-purple-500 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-3">生徒ポータル</h3>
                    <p class="text-gray-600 mb-4">予約確認・キャンセル・振替申請</p>
                    <button type="button" onclick="showPage('student-login')" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                        ログイン
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Registration Page -->
    <div id="student-register" class="page mt-24">
        <div class="container mx-auto max-w-2xl px-4">
            <div class="bg-white rounded-lg shadow-md p-8">
                <h2 class="text-2xl font-bold mb-6 text-center">生徒登録フォーム</h2>
                <p class="text-gray-600 text-center mb-8">年1回の希望時間提出で固定スケジュールが決まります</p>
                
                <form id="studentRegisterForm">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-user mr-2"></i>お名前 *
                            </label>
                            <input type="text" id="studentName" required 
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="例：田中花音">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-envelope mr-2"></i>メールアドレス *
                            </label>
                            <input type="email" id="studentEmail" required 
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="例：tanaka@example.com">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-phone mr-2"></i>電話番号
                            </label>
                            <input type="tel" id="studentPhone" 
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="例：090-1234-5678">
                        </div>

                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-800">希望レッスン時間（第1〜第3希望）</h3>
                            
                            <div class="bg-yellow-50 p-4 rounded-md">
                                <p class="text-sm text-yellow-800">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    毎週同じ時間でのレッスンとなります。30分刻みでお選びください。
                                </p>
                            </div>

                            <!-- First Choice -->
                            <div class="border border-gray-200 rounded-md p-4">
                                <h4 class="font-medium mb-3 text-blue-600">第1希望</h4>
                                <div id="calendarChoice1"></div>
                            </div>

                            <!-- Second Choice -->
                            <div class="border border-gray-200 rounded-md p-4">
                                <h4 class="font-medium mb-3 text-green-600">第2希望</h4>
                                <div id="calendarChoice2"></div>
                            </div>

                            <!-- Third Choice -->
                            <div class="border border-gray-200 rounded-md p-4">
                                <h4 class="font-medium mb-3 text-purple-600">第3希望</h4>
                                <div id="calendarChoice3"></div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-comment mr-2"></i>備考・要望
                            </label>
                            <textarea id="studentNotes" rows="3" 
                                      class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                      placeholder="その他ご要望があればお書きください"></textarea>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="bg-blue-600 text-white px-8 py-3 rounded-md text-lg font-medium hover:bg-blue-700 transition duration-200">
                                <i class="fas fa-paper-plane mr-2"></i>
                                登録する
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Teacher Login Page -->
    <div id="teacher-login" class="page mt-24">
        <div class="container mx-auto max-w-md px-4">
            <div class="bg-white rounded-lg shadow-md p-8">
                <div class="text-center mb-6">
                    <i class="fas fa-chalkboard-teacher text-4xl text-green-500 mb-4"></i>
                    <h2 class="text-2xl font-bold">講師ログイン</h2>
                    <p class="text-gray-600">管理者専用ページ</p>
                </div>
                
                <form id="teacherLoginForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-envelope mr-2"></i>メールアドレス
                            </label>
                            <input type="email" id="teacherEmail" required 
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                   placeholder="little.chopin-301@docomo.ne.jp">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-lock mr-2"></i>パスワード
                            </label>
                            <input type="password" id="teacherPassword" required 
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                   placeholder="パスワードを入力">
                        </div>

                        <button type="submit" class="w-full bg-green-600 text-white p-3 rounded-md font-medium hover:bg-green-700 transition duration-200">
                            <i class="fas fa-sign-in-alt mr-2"></i>
                            ログイン
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Teacher Dashboard -->
    <div id="teacher-dashboard" class="page mt-24">
        <div class="container mx-auto max-w-6xl px-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">講師管理画面</h2>
                <button onclick="teacherLogout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    <i class="fas fa-sign-out-alt mr-2"></i>ログアウト
                </button>
            </div>

            <div class="grid lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-blue-500 text-white p-4 rounded-lg">
                    <div class="text-2xl font-bold" id="totalStudents">0</div>
                    <div class="text-sm opacity-80">登録生徒数</div>
                </div>
                <div class="bg-green-500 text-white p-4 rounded-lg">
                    <div class="text-2xl font-bold" id="yearlyLessons">0</div>
                    <div class="text-sm opacity-80">年間レッスン数</div>
                </div>
                <div class="bg-yellow-500 text-white p-4 rounded-lg">
                    <div class="text-2xl font-bold" id="pendingRequests">0</div>
                    <div class="text-sm opacity-80">承認待ち申請</div>
                </div>
                <div class="bg-purple-500 text-white p-4 rounded-lg">
                    <div class="text-2xl font-bold" id="yearlyRevenue">¥0</div>
                    <div class="text-sm opacity-80">年間予想収入</div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md mb-6">
                <div class="p-4 border-b">
                    <div class="flex space-x-4">
                        <button onclick="showTeacherTab('schedule')" id="scheduleTab" class="px-4 py-2 bg-blue-500 text-white rounded">
                            <i class="fas fa-calendar-alt mr-2"></i>稼働時間設定
                        </button>
                        <button onclick="showTeacherTab('calendar')" id="calendarTab" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            <i class="fas fa-calendar-check mr-2"></i>予約カレンダー
                        </button>
                        <button onclick="showTeacherTab('requests')" id="requestsTab" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            <i class="fas fa-clipboard-list mr-2"></i>申請管理
                        </button>
                        <button onclick="showTeacherTab('students')" id="studentsTab" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            <i class="fas fa-users mr-2"></i>生徒一覧
                        </button>
                        <button onclick="showTeacherTab('pendingCalendar')" id="pendingCalendarTab" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            <i class="fas fa-calendar-plus mr-2"></i>申請カレンダー
                        </button>
                    </div>
                </div>

                <!-- Schedule Tab -->
                <div id="scheduleTabContent" class="teacherTabContent p-6">
                    <h3 class="text-lg font-semibold mb-4">週間稼働時間設定（30分刻み）</h3>
                    <p class="text-gray-600 mb-6">〇をクリックで稼働可能、×をクリックで稼働不可に設定できます</p>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="p-3 text-left">時間</th>
                                    <th class="p-3 text-center">月</th>
                                    <th class="p-3 text-center">火</th>
                                    <th class="p-3 text-center">水</th>
                                    <th class="p-3 text-center">木</th>
                                    <th class="p-3 text-center">金</th>
                                    <th class="p-3 text-center">土</th>
                                    <th class="p-3 text-center">日</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTable">
                                <!-- Generated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <button onclick="saveSchedule()" class="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600">
                            <i class="fas fa-save mr-2"></i>保存
                        </button>
                    </div>
                </div>

                <!-- Calendar Tab -->
                <div id="calendarTabContent" class="teacherTabContent p-6" style="display: none;">
                    <h3 class="text-lg font-semibold mb-4">予約カレンダー</h3>
                    <div id="teacherCalendar" style="height: 600px;"></div>
                </div>

                <!-- Requests Tab -->
                <div id="requestsTabContent" class="teacherTabContent p-6" style="display: none;">
                    <h3 class="text-lg font-semibold mb-4">申請管理</h3>
                    <div id="requestsList">
                        <!-- Generated by JavaScript -->
                    </div>
                </div>

                <!-- Students Tab -->
                <div id="studentsTabContent" class="teacherTabContent p-6" style="display: none;">
                    <h3 class="text-lg font-semibold mb-4">生徒一覧</h3>
                    <div id="studentsList">
                        <!-- Generated by JavaScript -->
                    </div>
                </div>

                <!-- Pending Requests Calendar Tab -->
                <div id="pendingCalendarTabContent" class="teacherTabContent p-6" style="display: none;">
                    <h3 class="text-lg font-semibold mb-4">承認待ち申請カレンダー</h3>
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 mb-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            カレンダー上の申請をクリックすると承認できます
                        </p>
                        <div id="studentColorLegend" class="flex flex-wrap gap-2 mt-2"></div>
                    </div>
                    <div id="pendingCalendar" style="height: 600px;"></div>
                </div>

                <!-- Manual Assign Tab -->
                <div id="manualAssignTabContent" class="teacherTabContent p-6" style="display: none;">
                    <h3 class="text-lg font-semibold mb-4">手動予約追加</h3>
                    <form id="manualAssignForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">生徒選択</label>
                            <select id="manualStudentSelect" required class="w-full border rounded p-2"></select>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-sm font-medium mb-1">日付</label>
                                <input type="date" id="manualDate" required class="w-full border rounded p-2" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">時間</label>
                                <select id="manualTime" required class="w-full border rounded p-2"></select>
                            </div>
                        </div>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            予約を追加
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Login Page -->
    <div id="student-login" class="page mt-24">
        <div class="container mx-auto max-w-md px-4">
            <div class="bg-white rounded-lg shadow-md p-8">
                <div class="text-center mb-6">
                    <i class="fas fa-user text-4xl text-purple-500 mb-4"></i>
                    <h2 class="text-2xl font-bold">生徒ポータル ログイン</h2>
                    <p class="text-gray-600">お名前とメールアドレスでログイン</p>
                </div>
                
                <form id="studentLoginForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-user mr-2"></i>お名前
                            </label>
                            <input type="text" id="loginStudentName" required 
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                   placeholder="登録したお名前を入力">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-envelope mr-2"></i>メールアドレス
                            </label>
                            <input type="email" id="loginStudentEmail" required 
                                   class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                   placeholder="登録したメールアドレスを入力">
                        </div>

                        <button type="submit" class="w-full bg-purple-600 text-white p-3 rounded-md font-medium hover:bg-purple-700 transition duration-200">
                            <i class="fas fa-sign-in-alt mr-2"></i>
                            ログイン
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Student Portal -->
    <div id="student-portal" class="page mt-24">
        <div class="container mx-auto max-w-4xl px-4">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold">生徒ポータル</h2>
                    <p class="text-gray-600">こんにちは、<span id="currentStudentName"></span>さん</p>
                </div>
                <button onclick="studentLogout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    <i class="fas fa-sign-out-alt mr-2"></i>ログアウト
                </button>
            </div>

            <!-- Current Schedule -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-calendar-check text-blue-500 mr-2"></i>
                    あなたの固定レッスンスケジュール
                </h3>
                <div id="studentSchedule" class="bg-blue-50 p-4 rounded-md">
                    <!-- Generated by JavaScript -->
                </div>
            </div>

            <!-- Actions -->
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4 text-red-500">
                        <i class="fas fa-times-circle mr-2"></i>
                        レッスンキャンセル
                    </h3>
                    <p class="text-gray-600 mb-4">急な都合でレッスンをお休みする場合</p>
                    <form id="cancelForm">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">キャンセル希望日</label>
                                <input type="date" id="cancelDate" required class="w-full p-2 border border-gray-300 rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">理由</label>
                                <textarea id="cancelReason" rows="2" class="w-full p-2 border border-gray-300 rounded" placeholder="キャンセル理由をお書きください"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-red-500 text-white p-2 rounded hover:bg-red-600">
                                キャンセル申請
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4 text-green-500">
                        <i class="fas fa-exchange-alt mr-2"></i>
                        振替レッスン申請
                    </h3>
                    <p class="text-gray-600 mb-4">別の日時に振り替えをご希望の場合</p>
                    <form id="makeupForm">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">振替元の日付</label>
                                <input type="date" id="makeupFromDate" required class="w-full p-2 border border-gray-300 rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">希望振替日時</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="date" id="makeupToDate" required class="p-2 border border-gray-300 rounded">
                                    <select id="makeupToTime" required class="p-2 border border-gray-300 rounded">
                                        <option value="">時間選択</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">理由</label>
                                <textarea id="makeupReason" rows="2" class="w-full p-2 border border-gray-300 rounded" placeholder="振替希望理由をお書きください"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600">
                                振替申請
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 新規レッスン候補カレンダー -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4 text-blue-500">
                    <i class="fas fa-calendar-alt mr-2"></i>先生の稼働スケジュール
                </h3>
                <p class="text-gray-600 mb-4">○の枠だけ選択できます（最大3つまで）</p>
                <div id="studentAvailabilityCalendar"></div>
            </div>

            <!-- 新規レッスン申請 -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4 text-blue-500">
                    <i class="fas fa-plus-circle mr-2"></i>
                    新規レッスン申請
                </h3>
                <p class="text-gray-600 mb-4">新しく希望するレッスン日時を申請します</p>
                <form id="newLessonForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">理由</label>
                            <textarea id="newLessonReason" rows="2" class="w-full p-2 border border-gray-300 rounded"></textarea>
                        </div>
                        <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
                            申請する
                        </button>
                    </div>
                </form>
            </div>

            <!-- Request History -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-history text-gray-500 mr-2"></i>
                    申請履歴
                </h3>
                <div id="studentRequests">
                    <!-- Generated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // Firebase Configuration
        // ==========================================
        
        // ⚠️ 重要: 以下の設定をあなたのFirebaseプロジェクトの設定に置き換えてください
        const firebaseConfig = {
            apiKey: "AIzaSyDuwQzcC9HlejgxpLAa8dK68xYwueoNmK4",
            authDomain: "piano-lesson-system.firebaseapp.com",
            projectId: "piano-lesson-system",
            storageBucket: "piano-lesson-system.firebasestorage.app",
            messagingSenderId: "94459879451",
            appId: "1:94459879451:web:342958cd3531b61fb818be",
            databaseURL: "https://piano-lesson-system-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        // Firebase初期化
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log('Firebase接続成功');
        } catch (error) {
            console.error('Firebase初期化エラー:', error);
            document.getElementById('firebaseConfigAlert').classList.remove('hidden');
        }

        // ==========================================
        // Global Variables
        // ==========================================
        let currentUser = null;
        let currentUserType = null;
        let teacherCalendar = null;
        let scheduleListener = null;
        let studentsListener = null;
        let requestsListener = null;
        let bookingsListener = null;

        // ==========================================
        // Firebase Helper Functions
        // ==========================================
        
        // データ保存
        async function saveToFirebase(path, data) {
            try {
                await db.ref(path).set(data);
                return true;
            } catch (error) {
                console.error('Firebase保存エラー:', error);
                return false;
            }
        }

        // データ更新
        async function updateFirebase(path, data) {
            try {
                await db.ref(path).update(data);
                return true;
            } catch (error) {
                console.error('Firebase更新エラー:', error);
                return false;
            }
        }

        // データ取得
        async function getFromFirebase(path) {
            try {
                const snapshot = await db.ref(path).once('value');
                return snapshot.val();
            } catch (error) {
                console.error('Firebase取得エラー:', error);
                return null;
            }
        }

        // リアルタイムリスナー設定
        function listenToFirebase(path, callback) {
            return db.ref(path).on('value', snapshot => {
                callback(snapshot.val() || {});
            });
        }

        // リスナー解除
        function removeFirebaseListener(path, listener) {
            if (listener) {
                db.ref(path).off('value', listener);
            }
        }

        // ==========================================
        // Connection Status
        // ==========================================
        
        // Firebase接続状態を監視
        if (db) {
            db.ref('.info/connected').on('value', (snapshot) => {
                const status = document.getElementById('connectionStatus');
                const text = document.getElementById('connectionText');
                
                if (snapshot.val() === true) {
                    status.className = 'inline-block px-4 py-2 rounded-full text-sm bg-green-100 text-green-800';
                    text.innerHTML = '<i class="fas fa-circle text-green-500 mr-2"></i>オンライン';
                } else {
                    status.className = 'inline-block px-4 py-2 rounded-full text-sm bg-red-100 text-red-800';
                    text.innerHTML = '<i class="fas fa-circle text-red-500 mr-2"></i>オフライン';
                }
            });
        }

        // ==========================================
        // Loading Functions
        // ==========================================
        
        function showLoading() {
            document.getElementById('loadingScreen').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        // ==========================================
        // Page Navigation
        // ==========================================
        
        window.showPage = function(pageId) {
            // 全ページを非表示
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // 対象ページを表示
            const target = document.getElementById(pageId);
            if (!target) {
                console.error(`ページ "${pageId}" が見つかりません`);
                return;
            }
            target.classList.add('active');

            // ページ別の初期化処理
            switch (pageId) {
                case 'teacher-dashboard':
                    setTimeout(() => {
                        initTeacherDashboard();
                    }, 100);
                    break;
                case 'student-register':
                    setTimeout(() => {
                        initStudentRegistration();
                    }, 100);
                    break;
                case 'student-portal':
                    setTimeout(() => {
                        initStudentPortal();
                    }, 100);
                    break;
            }
        };

        // ==========================================
        // Initialization
        // ==========================================
        
        async function initSystem() {
            showLoading();
            
            // 初期データのチェックと作成
            const teacherSchedule = await getFromFirebase('teacherSchedule');
            if (!teacherSchedule) {
                await saveToFirebase('teacherSchedule', {});
            }
            
            // 振替時間オプション用のイベントリスナー
            const makeupToDate = document.getElementById('makeupToDate');
            if (makeupToDate) {
                makeupToDate.addEventListener('change', loadMakeupTimeOptions);
            }
            
            hideLoading();
        }

        // Teacher Dashboard初期化
        async function initTeacherDashboard() {
            // リスナーをクリア
            removeFirebaseListener('teacherSchedule', scheduleListener);
            removeFirebaseListener('students', studentsListener);
            removeFirebaseListener('requests', requestsListener);
            removeFirebaseListener('bookings', bookingsListener);
            
            // 新しいリスナーを設定
            scheduleListener = listenToFirebase('teacherSchedule', () => {
                generateScheduleTable();
            });
            
            studentsListener = listenToFirebase('students', () => {
                loadStudentsList();
                updateDashboardStats();
                populateManualStudentOptions();
            });
            
            requestsListener = listenToFirebase('requests', () => {
                loadRequestsList();
                updateDashboardStats();
            });
            
            bookingsListener = listenToFirebase('bookings', () => {
                updateDashboardStats();
                if (teacherCalendar) initTeacherCalendar();
            });
            
            // 初期表示
            generateScheduleTable();
            populateManualTimeOptions();
        }

        // Student Registration初期化
        async function initStudentRegistration() {
            showLoading();
            const teacherSchedule = await getFromFirebase('teacherSchedule');
            initStudentAvailabilityCalendarForRegister(teacherSchedule || {});
            hideLoading();
        }

        // Student Portal初期化
        async function initStudentPortal() {
            if (!currentUser) return;
            
            showLoading();
            
            // リアルタイムで自分のデータを監視
            listenToFirebase(`students/${currentUser.id}`, (studentData) => {
                if (studentData) {
                    currentUser = studentData;
                    loadStudentSchedule();
                }
            });
            
            // 申請履歴を監視
            listenToFirebase('requests', (requests) => {
                loadStudentRequests(requests);
            });
            
            // 先生のスケジュールを監視
            listenToFirebase('teacherSchedule', (schedule) => {
                initStudentAvailabilityCalendar(schedule);
            });
            
            hideLoading();
        }

        // ==========================================
        // DOMContentLoaded
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', function() {
            initSystem();
            showPage('home');

            // Login form handlers
            const teacherLoginForm = document.getElementById('teacherLoginForm');
            if (teacherLoginForm) {
                teacherLoginForm.addEventListener('submit', handleTeacherLogin);
            }

            const studentLoginForm = document.getElementById('studentLoginForm');
            if (studentLoginForm) {
                studentLoginForm.addEventListener('submit', handleStudentLogin);
            }

            // Student registration form
            const studentRegisterForm = document.getElementById('studentRegisterForm');
            if (studentRegisterForm) {
                studentRegisterForm.addEventListener('submit', handleStudentRegistration);
            }

            // Cancel form
            const cancelForm = document.getElementById('cancelForm');
            if (cancelForm) {
                cancelForm.addEventListener('submit', handleCancelRequest);
            }

            // Makeup form
            const makeupForm = document.getElementById('makeupForm');
            if (makeupForm) {
                makeupForm.addEventListener('submit', handleMakeupRequest);
            }

            // New lesson form
            const newLessonForm = document.getElementById('newLessonForm');
            if (newLessonForm) {
                newLessonForm.addEventListener('submit', handleNewLessonRequest);
            }

            // Manual assign form
            const manualAssignForm = document.getElementById('manualAssignForm');
            if (manualAssignForm) {
                manualAssignForm.addEventListener('submit', handleManualAssign);
            }
        });

        // ==========================================
        // Authentication Handlers
        // ==========================================
        
        async function handleTeacherLogin(e) {
            e.preventDefault();
            showLoading();
            
            const email = document.getElementById('teacherEmail').value;
            const password = document.getElementById('teacherPassword').value;

            if (email === 'little.chopin-301@docomo.ne.jp' && password === 'kobuta121') {
                currentUser = { email: email };
                currentUserType = 'teacher';
                hideLoading();
                showPage('teacher-dashboard');
            } else {
                hideLoading();
                alert('メールアドレスまたはパスワードが間違っています。');
            }
        }

        async function handleStudentLogin(e) {
            e.preventDefault();
            showLoading();
            
            const name = document.getElementById('loginStudentName').value;
            const email = document.getElementById('loginStudentEmail').value;

            const students = await getFromFirebase('students') || {};
            const student = Object.values(students).find(s => s.name === name && s.email === email);

            if (student) {
                currentUser = student;
                currentUserType = 'student';
                document.getElementById('currentStudentName').textContent = student.name;
                hideLoading();
                showPage('student-portal');
            } else {
                hideLoading();
                alert('お名前またはメールアドレスが見つかりません。');
            }
        }

        // ==========================================
        // Registration Handler
        // ==========================================
        
        async function handleStudentRegistration(e) {
            e.preventDefault();
            showLoading();

            const choices = [];
            for (let i = 1; i <= 3; i++) {
                const slot = localStorage.getItem(`registerChoice${i}`);
                if (slot) {
                    const [day, time] = slot.split('_');
                    choices.push({ day, time });
                }
            }

            const studentId = Date.now().toString();
            const studentData = {
                id: studentId,
                name: document.getElementById('studentName').value,
                email: document.getElementById('studentEmail').value,
                phone: document.getElementById('studentPhone').value,
                choices: choices,
                notes: document.getElementById('studentNotes').value,
                registeredAt: new Date().toISOString(),
                assignedSchedule: null
            };

            // Firebaseに保存
            await saveToFirebase(`students/${studentId}`, studentData);

            // 申請も作成
            const requests = {};
            studentData.choices.forEach((choice, index) => {
                const requestId = Date.now().toString() + index;
                requests[requestId] = {
                    id: requestId,
                    studentId: studentData.id,
                    studentName: studentData.name,
                    type: 'new',
                    day: choice.day,
                    time: choice.time,
                    reason: `第${index + 1}希望`,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
            });
            
            await updateFirebase('requests', requests);

            // ローカルストレージクリア
            for (let i = 1; i <= 3; i++) {
                localStorage.removeItem(`registerChoice${i}`);
            }

            hideLoading();
            alert('登録が完了しました！先生による承認後にスケジュールが確定します。');
            document.getElementById('studentRegisterForm').reset();
            showPage('home');
        }

        // ==========================================
        // Request Handlers
        // ==========================================
        
        async function handleCancelRequest(e) {
            e.preventDefault();
            if (!currentUser) return;
            
            showLoading();
            
            const requestId = Date.now().toString();
            const request = {
                id: requestId,
                studentId: currentUser.id,
                studentName: currentUser.name,
                type: 'cancel',
                date: document.getElementById('cancelDate').value,
                reason: document.getElementById('cancelReason').value,
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            await saveToFirebase(`requests/${requestId}`, request);
            
            hideLoading();
            alert('キャンセル申請を送信しました。承認をお待ちください。');
            document.getElementById('cancelForm').reset();
        }

        async function handleMakeupRequest(e) {
            e.preventDefault();
            if (!currentUser) return;
            
            showLoading();
            
            const requestId = Date.now().toString();
            const request = {
                id: requestId,
                studentId: currentUser.id,
                studentName: currentUser.name,
                type: 'makeup',
                fromDate: document.getElementById('makeupFromDate').value,
                toDate: document.getElementById('makeupToDate').value,
                toTime: document.getElementById('makeupToTime').value,
                reason: document.getElementById('makeupReason').value,
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            await saveToFirebase(`requests/${requestId}`, request);
            
            hideLoading();
            alert('振替申請を送信しました。承認をお待ちください。');
            document.getElementById('makeupForm').reset();
        }

        async function handleNewLessonRequest(e) {
            e.preventDefault();
            if (!currentUser) return;

            const selectedSlots = JSON.parse(localStorage.getItem('studentSelectedSlots') || '[]');
            if (selectedSlots.length === 0) {
                alert('希望枠を○カレンダーから選択してください');
                return;
            }

            showLoading();

            const reason = document.getElementById('newLessonReason').value;
            const requests = {};
            
            for (let i = 0; i < selectedSlots.length; i++) {
                const [day, time] = selectedSlots[i].split('_');
                const requestId = Date.now().toString() + '_' + i;
                requests[requestId] = {
                    id: requestId,
                    studentId: currentUser.id,
                    studentName: currentUser.name,
                    type: 'new',
                    day,
                    time,
                    reason: reason || `第${i + 1}希望`,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
            }
            
            await updateFirebase('requests', requests);

            localStorage.removeItem('studentSelectedSlots');
            hideLoading();
            alert('新規レッスン申請を送信しました。先生の承認をお待ちください。');
            document.getElementById('newLessonForm').reset();
        }

        async function handleManualAssign(e) {
            e.preventDefault();
            showLoading();

            const email = document.getElementById('manualStudentSelect').value;
            const date = document.getElementById('manualDate').value;
            const time = document.getElementById('manualTime').value;

            const students = await getFromFirebase('students') || {};
            const student = Object.values(students).find(s => s.email === email);
            
            if (!student) {
                hideLoading();
                alert('生徒情報が見つかりません');
                return;
            }

            const bookingId = Date.now().toString();
            const booking = {
                id: bookingId,
                studentId: student.id,
                studentName: student.name,
                date: date,
                time: time,
                type: 'manual',
                status: 'confirmed',
                createdAt: new Date().toISOString()
            };

            await saveToFirebase(`bookings/${bookingId}`, booking);
            
            hideLoading();
            alert('予約を追加しました');
            document.getElementById('manualAssignForm').reset();
        }

        // ==========================================
        // Logout Functions
        // ==========================================
        
        window.teacherLogout = function() {
            // リスナーをクリア
            removeFirebaseListener('teacherSchedule', scheduleListener);
            removeFirebaseListener('students', studentsListener);
            removeFirebaseListener('requests', requestsListener);
            removeFirebaseListener('bookings', bookingsListener);
            
            currentUser = null;
            currentUserType = null;
            showPage('home');
        }

        window.studentLogout = function() {
            currentUser = null;
            currentUserType = null;
            showPage('home');
        }

        // ==========================================
        // Schedule Management
        // ==========================================
        
        async function generateScheduleTable() {
            const table = document.getElementById('scheduleTable');
            if (!table) return;
            
            const days = ['月', '火', '水', '木', '金', '土', '日'];
            const teacherSchedule = await getFromFirebase('teacherSchedule') || {};
            
            table.innerHTML = '';

            for (let hour = 9; hour <= 20; hour++) {
                for (let minute = 0; minute < 60; minute += 30) {
                    const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    const endHour = minute === 30 ? hour + 1 : hour;
                    const endMinute = minute === 30 ? 0 : 30;
                    const endTimeStr = `${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="p-2 font-medium">${timeStr} - ${endTimeStr}</td>`;

                    days.forEach(day => {
                        const key = `${day}_${timeStr}`;
                        const isAvailable = teacherSchedule[key] === true;
                        const cell = document.createElement('td');
                        cell.className = 'p-2 text-center';
                        cell.innerHTML = `
                            <div class="time-slot ${isAvailable ? 'available' : 'unavailable'}" 
                                 onclick="toggleSlot('${key}')" 
                                 data-key="${key}">
                                ${isAvailable ? '○' : '×'}
                            </div>
                        `;
                        row.appendChild(cell);
                    });

                    table.appendChild(row);
                }
            }
        }

        window.toggleSlot = async function(key) {
            const teacherSchedule = await getFromFirebase('teacherSchedule') || {};
            teacherSchedule[key] = !teacherSchedule[key];
            await saveToFirebase('teacherSchedule', teacherSchedule);
        }

        window.saveSchedule = function() {
            alert('スケジュールは自動的に保存されています。');
        }

        // ==========================================
        // Tab Navigation
        // ==========================================
        
        window.showTeacherTab = function(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.teacherTabContent').forEach(content => {
                content.style.display = 'none';
            });

            // Show selected tab content
            const tabContent = document.getElementById(tabName + 'TabContent');
            if (tabContent) {
                tabContent.style.display = 'block';
            }

            // Update tab buttons
            const tabs = ['schedule', 'calendar', 'requests', 'students', 'pendingCalendar'];
            tabs.forEach(tab => {
                const btn = document.getElementById(tab + 'Tab');
                if (btn) {
                    if (tab === tabName) {
                        btn.className = 'px-4 py-2 bg-blue-500 text-white rounded';
                    } else {
                        btn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300';
                    }
                }
            });

            // タブごとの処理
            if (tabName === 'calendar') {
                setTimeout(initTeacherCalendar, 100);
            }
            if (tabName === 'pendingCalendar') {
                setTimeout(initPendingCalendar, 100);
            }
        }

        // ==========================================
        // Calendar Functions
        // ==========================================
        
        async function initTeacherCalendar() {
            if (teacherCalendar) teacherCalendar.destroy();

            const calendarEl = document.getElementById('teacherCalendar');
            if (!calendarEl) return;

            const events = await getConfirmedReservationsForCalendar();

            teacherCalendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                locale: 'ja',
                allDaySlot: false,
                slotMinTime: '09:00:00',
                slotMaxTime: '21:00:00',
                slotDuration: '00:30:00',
                slotLabelInterval: '01:00:00',
                eventTimeFormat: {
                    hour: '2-digit',
                    minute: '2-digit',
                    meridiem: false
                },
                events: events,
                eventClick: function(info) {
                    if (confirm(`${info.event.title} を削除しますか？`)) {
                        deleteReservationById(info.event.id);
                        info.event.remove();
                        alert("予約を削除しました");
                    }
                }
            });

            teacherCalendar.render();
        }

        async function getConfirmedReservationsForCalendar() {
            const bookings = await getFromFirebase('bookings') || {};
            const events = [];

            Object.values(bookings).forEach(booking => {
                if (booking.status === 'confirmed') {
                    events.push({
                        id: booking.id,
                        title: booking.studentName,
                        start: `${booking.date}T${booking.time}`,
                        end: getEndTime(`${booking.date}T${booking.time}`),
                        color: '#2563eb'
                    });
                }
            });

            return events;
        }

        function getEndTime(startISO) {
            const start = new Date(startISO);
            start.setMinutes(start.getMinutes() + 30);
            return start.toISOString();
        }

        async function deleteReservationById(id) {
            await db.ref(`bookings/${id}`).remove();
        }

        // 生徒ごとの色を管理
        const studentColors = {};
        const colorPalette = [
            { bg: '#3B82F6', border: '#2563EB' }, // 青
            { bg: '#10B981', border: '#059669' }, // 緑
            { bg: '#F59E0B', border: '#D97706' }, // オレンジ
            { bg: '#EF4444', border: '#DC2626' }, // 赤
            { bg: '#8B5CF6', border: '#7C3AED' }, // 紫
            { bg: '#EC4899', border: '#DB2777' }, // ピンク
            { bg: '#14B8A6', border: '#0D9488' }, // ティール
            { bg: '#F97316', border: '#EA580C' }, // オレンジレッド
            { bg: '#6366F1', border: '#4F46E5' }, // インディゴ
            { bg: '#84CC16', border: '#65A30D' }, // ライム
        ];
        let colorIndex = 0;

        async function initPendingCalendar() {
            const requests = await getFromFirebase('requests') || {};
            const pending = Object.values(requests).filter(r => r.status === 'pending');

            // 生徒ごとに色を割り当て
            const legendContainer = document.getElementById('studentColorLegend');
            if (legendContainer) {
                legendContainer.innerHTML = '';
            }

            const uniqueStudents = {};
            pending.forEach(req => {
                if (!studentColors[req.studentId]) {
                    studentColors[req.studentId] = colorPalette[colorIndex % colorPalette.length];
                    colorIndex++;
                }
                uniqueStudents[req.studentId] = req.studentName;
            });

            // 色の凡例を表示
            if (legendContainer) {
                Object.entries(uniqueStudents).forEach(([studentId, studentName]) => {
                    const color = studentColors[studentId];
                    const legendItem = document.createElement('div');
                    legendItem.className = 'flex items-center space-x-2';
                    legendItem.innerHTML = `
                        <div class="w-4 h-4 rounded" style="background-color: ${color.bg}"></div>
                        <span class="text-sm">${studentName}</span>
                    `;
                    legendContainer.appendChild(legendItem);
                });
            }

            const events = pending.map(req => {
                const color = studentColors[req.studentId];
                
                if (req.type === 'new') {
                    // 時間とともに名前も表示
                    const endHour = parseInt(req.time.split(':')[0]) + (parseInt(req.time.split(':')[1]) >= 30 ? 1 : 0);
                    const endMinute = parseInt(req.time.split(':')[1]) + 30 >= 60 ? 
                        parseInt(req.time.split(':')[1]) + 30 - 60 : 
                        parseInt(req.time.split(':')[1]) + 30;
                    const endTime = `${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`;
                    
                    return {
                        title: `${req.studentName}`,
                        start: getNextDate(req.day) + 'T' + req.time,
                        backgroundColor: color.bg,
                        borderColor: color.border,
                        textColor: '#FFFFFF',
                        extendedProps: { 
                            requestId: req.id, 
                            studentName: req.studentName,
                            time: `${req.time}-${endTime}`,
                            reason: req.reason
                        }
                    };
                } else if (req.type === 'makeup') {
                    return {
                        title: `${req.studentName} (振替)`,
                        start: req.toDate + 'T' + req.toTime,
                        backgroundColor: color.bg,
                        borderColor: color.border,
                        textColor: '#FFFFFF',
                        extendedProps: { 
                            requestId: req.id, 
                            studentName: req.studentName,
                            type: '振替申請'
                        }
                    };
                } else if (req.type === 'cancel') {
                    return {
                        title: `${req.studentName} (キャンセル)`,
                        start: req.date,
                        backgroundColor: color.bg,
                        borderColor: color.border,
                        textColor: '#FFFFFF',
                        allDay: true,
                        extendedProps: { 
                            requestId: req.id, 
                            studentName: req.studentName,
                            type: 'キャンセル申請'
                        }
                    };
                }
                return null;
            }).filter(e => e);

            const calendarEl = document.getElementById('pendingCalendar');
            if (!calendarEl) return;

            if (calendarEl._calendar) {
                calendarEl._calendar.destroy();
            }

            const pendingCalendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                locale: 'ja',
                headerToolbar: {
                    left: '',
                    center: '',
                    right: ''
                },
                titleFormat: { year: 'numeric', month: 'short' },
                dayHeaderFormat: { weekday: 'short' },
                slotMinTime: '09:00',
                slotMaxTime: '21:00',
                slotDuration: '00:30',
                slotLabelInterval: '01:00',
                allDaySlot: false,
                weekNumbers: false,
                dayHeaders: true,
                nowIndicator: true,
                events: events,
                height: 600,
                eventTimeFormat: {
                    hour: 'numeric',
                    minute: '2-digit',
                    meridiem: false
                },
                eventClick: function(info) {
                    const requestId = info.event.extendedProps.requestId;
                    const studentName = info.event.extendedProps.studentName;
                    const time = info.event.extendedProps.time || '';
                    const type = info.event.extendedProps.type || '新規申請';
                    const reason = info.event.extendedProps.reason || '';
                    
                    let message = `${studentName}さんの${type}`;
                    if (time) message += `\n時間: ${time}`;
                    if (reason) message += `\n理由: ${reason}`;
                    message += '\n\n承認しますか？';
                    
                    if (confirm(message)) {
                        approveRequest(requestId);
                        initPendingCalendar();
                    }
                },
                eventDidMount: function(info) {
                    // ツールチップの追加
                    const time = info.event.extendedProps.time || '';
                    const tooltipText = time ? 
                        `${info.event.title} ${time} - クリックで承認` : 
                        `${info.event.title} - クリックで承認`;
                    
                    info.el.setAttribute('title', tooltipText);
                    info.el.style.fontSize = '11px';
                    info.el.style.padding = '2px 4px';
                    info.el.style.borderRadius = '4px';
                    info.el.style.cursor = 'pointer';
                    info.el.style.fontWeight = '500';
                }
            });

            pendingCalendar.render();
            calendarEl._calendar = pendingCalendar;
        }

        // ==========================================
        // Dashboard Functions
        // ==========================================
        
        async function updateDashboardStats() {
            const students = await getFromFirebase('students') || {};
            const bookings = await getFromFirebase('bookings') || {};
            const requests = await getFromFirebase('requests') || {};
            
            const studentsArray = Object.values(students);
            const bookingsArray = Object.values(bookings);
            const pendingRequests = Object.values(requests).filter(r => r.status === 'pending');

            // 年間レッスン数を計算（確定済みの予約数）
            const yearlyLessons = bookingsArray.filter(b => b.status === 'confirmed').length;
            
            // 年間予想収入を計算（1レッスン1750円）
            const yearlyRevenue = yearlyLessons * 1750;

            const totalStudentsEl = document.getElementById('totalStudents');
            const yearlyLessonsEl = document.getElementById('yearlyLessons');
            const pendingRequestsEl = document.getElementById('pendingRequests');
            const yearlyRevenueEl = document.getElementById('yearlyRevenue');

            if (totalStudentsEl) totalStudentsEl.textContent = studentsArray.length;
            if (yearlyLessonsEl) yearlyLessonsEl.textContent = yearlyLessons;
            if (pendingRequestsEl) pendingRequestsEl.textContent = pendingRequests.length;
            if (yearlyRevenueEl) yearlyRevenueEl.textContent = `¥${yearlyRevenue.toLocaleString()}`;
        }

        async function loadStudentsList() {
            const students = await getFromFirebase('students') || {};
            const container = document.getElementById('studentsList');
            
            if (!container) return;

            const studentsArray = Object.values(students);

            if (studentsArray.length === 0) {
                container.innerHTML = '<p class="text-gray-500">登録された生徒はまだいません。</p>';
                return;
            }

            container.innerHTML = studentsArray.map(student => `
                <div class="border border-gray-200 rounded-md p-4 mb-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-lg">${student.name}</h4>
                            <p class="text-gray-600">${student.email}</p>
                            ${student.phone ? `<p class="text-gray-600">${student.phone}</p>` : ''}
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-500">登録日</div>
                            <div class="text-sm">${new Date(student.registeredAt).toLocaleDateString('ja-JP')}</div>
                        </div>
                    </div>
                    ${student.assignedSchedule ? `
                        <div class="mt-3 bg-blue-50 p-3 rounded">
                            <div class="text-sm font-medium text-blue-800">割り当てスケジュール</div>
                            <div class="text-blue-600">毎週${student.assignedSchedule.day}曜日 ${student.assignedSchedule.time}〜</div>
                        </div>
                    ` : `
                        <div class="mt-3 bg-yellow-50 p-3 rounded">
                            <div class="text-sm font-medium text-yellow-800">スケジュール未割り当て</div>
                            <div class="text-yellow-600">先生の承認待ちです</div>
                        </div>
                    `}
                    ${student.notes ? `
                        <div class="mt-3">
                            <div class="text-sm font-medium text-gray-700">備考</div>
                            <div class="text-sm text-gray-600">${student.notes}</div>
                        </div>
                    ` : ''}
                    <div class="mt-3 text-right space-x-2">
                        <button onclick="openManualAssign('${student.id}')" 
                                class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                            手動割り振り
                        </button>
                        <button onclick="deleteStudent('${student.id}')" 
                                class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                            削除
                        </button>
                    </div>
                </div>
            `).join('');
        }

        window.deleteStudent = async function(studentId) {
            if (!confirm('本当にこの生徒を削除しますか？')) return;
            
            showLoading();
            
            // 生徒データを削除
            await db.ref(`students/${studentId}`).remove();
            
            // 関連する申請を削除
            const requests = await getFromFirebase('requests') || {};
            const deletePromises = [];
            
            Object.entries(requests).forEach(([id, request]) => {
                if (request.studentId === studentId) {
                    deletePromises.push(db.ref(`requests/${id}`).remove());
                }
            });
            
            // 関連する予約を削除
            const bookings = await getFromFirebase('bookings') || {};
            Object.entries(bookings).forEach(([id, booking]) => {
                if (booking.studentId === studentId) {
                    deletePromises.push(db.ref(`bookings/${id}`).remove());
                }
            });
            
            await Promise.all(deletePromises);
            
            hideLoading();
            alert('生徒を削除しました。');
        };

        async function loadRequestsList() {
            const requests = await getFromFirebase('requests') || {};
            const container = document.getElementById('requestsList');
            
            if (!container) return;

            const requestsArray = Object.values(requests);

            if (requestsArray.length === 0) {
                container.innerHTML = '<p class="text-gray-500">申請はありません。</p>';
                return;
            }

            const sortedRequests = requestsArray.sort((a, b) => 
                new Date(b.createdAt) - new Date(a.createdAt)
            );

            container.innerHTML = sortedRequests.map(request => {
                let content = '';
                
                if (request.type === 'new') {
                    content = `
                        <h4 class="font-semibold">${request.studentName}</h4>
                        <div class="text-sm text-gray-600 mb-2">新規レッスン申請</div>
                        <p><strong>希望曜日:</strong> ${request.day}曜日</p>
                        <p><strong>希望時間:</strong> ${request.time}</p>
                        <p><strong>理由:</strong> ${request.reason}</p>
                    `;
                } else if (request.type === 'cancel') {
                    content = `
                        <h4 class="font-semibold">${request.studentName}</h4>
                        <div class="text-sm text-gray-600 mb-2">キャンセル申請</div>
                        <p><strong>キャンセル希望日:</strong> ${request.date}</p>
                        <p><strong>理由:</strong> ${request.reason}</p>
                    `;
                } else if (request.type === 'makeup') {
                    content = `
                        <h4 class="font-semibold">${request.studentName}</h4>
                        <div class="text-sm text-gray-600 mb-2">振替申請</div>
                        <p><strong>振替元:</strong> ${request.fromDate}</p>
                        <p><strong>振替先:</strong> ${request.toDate} ${request.toTime}</p>
                        <p><strong>理由:</strong> ${request.reason}</p>
                    `;
                }

                return `
                    <div class="border border-gray-200 rounded-md p-4 mb-4">
                        <div class="flex justify-between items-start">
                            <div>${content}</div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500 mb-2">
                                    ${new Date(request.createdAt).toLocaleDateString('ja-JP')}
                                </div>
                                <div class="text-sm px-2 py-1 rounded ${
                                    request.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                    request.status === 'approved' ? 'bg-green-100 text-green-800' :
                                    'bg-red-100 text-red-800'
                                }">
                                    ${
                                        request.status === 'pending' ? '承認待ち' :
                                        request.status === 'approved' ? '承認済み' :
                                        '却下'
                                    }
                                </div>
                            </div>
                        </div>
                        ${request.status === 'pending' ? `
                            <div class="mt-4 flex space-x-2">
                                <button onclick="approveRequest('${request.id}')" 
                                        class="bg-green-500 text-white px-4 py-2 rounded text-sm hover:bg-green-600">
                                    承認
                                </button>
                                <button onclick="rejectRequest('${request.id}')" 
                                        class="bg-red-500 text-white px-4 py-2 rounded text-sm hover:bg-red-600">
                                    却下
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        window.approveRequest = async function(requestId) {
            showLoading();
            
            const request = await getFromFirebase(`requests/${requestId}`);
            if (!request) {
                hideLoading();
                alert('申請が見つかりません');
                return;
            }

            // 申請を承認済みに更新
            await updateFirebase(`requests/${requestId}`, { status: 'approved' });

            if (request.type === 'new') {
                // 生徒にスケジュールを割り当て
                await updateFirebase(`students/${request.studentId}`, {
                    assignedSchedule: { day: request.day, time: request.time }
                });

                // 年度末まで毎週の予約を作成
                await addWeeklyBookingsUntilFiscalEnd(request.studentId, request.studentName, request.day, request.time);
            }

            hideLoading();
            alert('申請を承認しました。');
        }

        window.rejectRequest = async function(requestId) {
            showLoading();
            await updateFirebase(`requests/${requestId}`, { status: 'rejected' });
            hideLoading();
            alert('申請を却下しました。');
        }

        async function addWeeklyBookingsUntilFiscalEnd(studentId, studentName, day, time) {
            const startDate = new Date();
            const targetDay = { '日':0,'月':1,'火':2,'水':3,'木':4,'金':5,'土':6 }[day];

            let firstLessonDate = new Date(startDate);
            while (firstLessonDate.getDay() !== targetDay) {
                firstLessonDate.setDate(firstLessonDate.getDate() + 1);
            }

            const year = startDate.getMonth() >= 4 ? startDate.getFullYear() + 1 : startDate.getFullYear();
            const fiscalEnd = new Date(`${year}-03-31T23:59:59`);

            const bookings = {};
            let current = new Date(firstLessonDate);
            
            while (current <= fiscalEnd) {
                const bookingId = `${studentId}_${current.toISOString().split('T')[0]}_${time}`;
                bookings[bookingId] = {
                    id: bookingId,
                    studentId: studentId,
                    studentName: studentName,
                    day,
                    time,
                    date: current.toISOString().split('T')[0],
                    type: 'regular',
                    status: 'confirmed'
                };
                current.setDate(current.getDate() + 7);
            }

            await updateFirebase('bookings', bookings);
        }

        // ==========================================
        // Student Portal Functions
        // ==========================================
        
        function loadStudentSchedule() {
            const container = document.getElementById('studentSchedule');
            if (!container || !currentUser) return;
            
            if (currentUser.assignedSchedule) {
                const schedule = currentUser.assignedSchedule;
                const endHour = parseInt(schedule.time.split(':')[0]) + (parseInt(schedule.time.split(':')[1]) >= 30 ? 1 : 0);
                const endMinute = parseInt(schedule.time.split(':')[1]) + 30 >= 60 ? 
                    parseInt(schedule.time.split(':')[1]) + 30 - 60 : 
                    parseInt(schedule.time.split(':')[1]) + 30;
                const endTime = `${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`;
                
                container.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600 mb-2">
                            毎週${schedule.day}曜日 ${schedule.time} - ${endTime}
                        </div>
                        <div class="text-gray-600">
                            固定レッスンスケジュール
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="text-center text-gray-500">
                        スケジュールがまだ割り当てられていません。<br>
                        講師より個別にご連絡いたします。
                    </div>
                `;
            }
        }

        function loadStudentRequests(requests) {
            if (!currentUser) return;
            
            const studentRequests = Object.values(requests || {}).filter(r => r.studentId === currentUser.id);
            const container = document.getElementById('studentRequests');
            
            if (!container) return;

            if (studentRequests.length === 0) {
                container.innerHTML = '<p class="text-gray-500">申請履歴はありません。</p>';
                return;
            }

            container.innerHTML = studentRequests.map(request => {
                let content = '';
                
                if (request.type === 'new') {
                    content = `
                        <div class="font-medium mb-2">新規レッスン申請</div>
                        <p class="text-sm text-gray-600"><strong>希望曜日:</strong> ${request.day}曜日</p>
                        <p class="text-sm text-gray-600"><strong>希望時間:</strong> ${request.time}</p>
                        <p class="text-sm text-gray-600"><strong>理由:</strong> ${request.reason}</p>
                    `;
                } else if (request.type === 'cancel') {
                    content = `
                        <div class="font-medium mb-2">キャンセル申請</div>
                        <p class="text-sm text-gray-600"><strong>キャンセル希望日:</strong> ${request.date}</p>
                        <p class="text-sm text-gray-600"><strong>理由:</strong> ${request.reason}</p>
                    `;
                } else if (request.type === 'makeup') {
                    content = `
                        <div class="font-medium mb-2">振替申請</div>
                        <p class="text-sm text-gray-600"><strong>振替元:</strong> ${request.fromDate}</p>
                        <p class="text-sm text-gray-600"><strong>振替先:</strong> ${request.toDate} ${request.toTime}</p>
                        <p class="text-sm text-gray-600"><strong>理由:</strong> ${request.reason}</p>
                    `;
                }

                return `
                    <div class="border border-gray-200 rounded-md p-4 mb-4">
                        <div class="flex justify-between items-start">
                            <div>${content}</div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500 mb-2">
                                    ${new Date(request.createdAt).toLocaleDateString('ja-JP')}
                                </div>
                                <div class="text-sm px-2 py-1 rounded ${
                                    request.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                    request.status === 'approved' ? 'bg-green-100 text-green-800' :
                                    'bg-red-100 text-red-800'
                                }">
                                    ${
                                        request.status === 'pending' ? '承認待ち' :
                                        request.status === 'approved' ? '承認済み' :
                                        '却下'
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==========================================
        // Availability Calendar Functions
        // ==========================================
        
        function initStudentAvailabilityCalendarForRegister(teacherSchedule) {
            const days = ['月', '火', '水', '木', '金', '土', '日'];

            for (let choiceNum = 1; choiceNum <= 3; choiceNum++) {
                const container = document.getElementById(`calendarChoice${choiceNum}`);
                if (!container) continue;

                let html = '<table class="w-full border-collapse">';
                html += '<thead><tr class="bg-gray-50"><th class="p-2">時間</th>';
                days.forEach(d => html += `<th class="p-2 text-center">${d}</th>`);
                html += '</tr></thead><tbody>';

                for (let hour = 9; hour <= 20; hour++) {
                    for (let minute = 0; minute < 60; minute += 30) {
                        const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        const endHour = minute === 30 ? hour + 1 : hour;
                        const endMinute = minute === 30 ? 0 : 30;
                        const endTimeStr = `${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`;

                        html += `<tr><td class="p-2 font-medium text-sm">${timeStr} - ${endTimeStr}</td>`;
                        days.forEach(day => {
                            const key = `${day}_${timeStr}`;
                            const isAvailable = teacherSchedule[key] === true;
                            if (isAvailable) {
                                html += `<td class="p-2 text-center cursor-pointer bg-green-100 hover:bg-green-200" data-key="${key}" data-choice="${choiceNum}">○</td>`;
                            } else {
                                html += `<td class="p-2 text-center bg-red-100">×</td>`;
                            }
                        });
                        html += '</tr>';
                    }
                }
                html += '</tbody></table>';
                container.innerHTML = html;

                // クリックで選択
                container.querySelectorAll('td[data-key]').forEach(cell => {
                    cell.addEventListener('click', function() {
                        // 同じ選択肢内の既存選択をクリア
                        container.querySelectorAll('td[data-key]').forEach(c => {
                            c.classList.remove('bg-blue-300');
                            c.textContent = '○';
                        });
                        
                        // 新しい選択を設定
                        this.classList.add('bg-blue-300');
                        this.textContent = '✓';
                        
                        const selectedKey = this.getAttribute('data-key');
                        localStorage.setItem(`registerChoice${choiceNum}`, selectedKey);
                    });
                });
            }
        }

        function initStudentAvailabilityCalendar(teacherSchedule) {
            const container = document.getElementById('studentAvailabilityCalendar');
            if (!container) return;

            const days = ['月', '火', '水', '木', '金', '土', '日'];

            let html = '<table class="w-full border-collapse">';
            html += '<thead><tr class="bg-gray-50"><th class="p-2">時間</th>';
            days.forEach(d => html += `<th class="p-2 text-center">${d}</th>`);
            html += '</tr></thead><tbody>';

            let selectedSlots = JSON.parse(localStorage.getItem('studentSelectedSlots') || '[]');

            for (let hour = 9; hour <= 20; hour++) {
                for (let minute = 0; minute < 60; minute += 30) {
                    const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    const endHour = minute === 30 ? hour + 1 : hour;
                    const endMinute = minute === 30 ? 0 : 30;
                    const endTimeStr = `${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`;
                    
                    html += `<tr><td class="p-2 font-medium text-sm">${timeStr} - ${endTimeStr}</td>`;

                    days.forEach(day => {
                        const key = `${day}_${timeStr}`;
                        const isAvailable = teacherSchedule[key] === true;
                        const isSelected = selectedSlots.includes(key);
                        
                        if (isAvailable) {
                            const bgClass = isSelected ? 'bg-blue-300' : 'bg-green-100 hover:bg-green-200';
                            const text = isSelected ? '✓' : '○';
                            html += `<td class="p-2 text-center cursor-pointer ${bgClass}" data-key="${key}">${text}</td>`;
                        } else {
                            html += `<td class="p-2 text-center bg-red-100">×</td>`;
                        }
                    });

                    html += '</tr>';
                }
            }
            html += '</tbody></table>';
            container.innerHTML = html;

            // ○クリックで選択（最大3つ）
            container.querySelectorAll('td[data-key]').forEach(cell => {
                cell.addEventListener('click', function() {
                    const key = this.getAttribute('data-key');
                    let selectedSlots = JSON.parse(localStorage.getItem('studentSelectedSlots') || '[]');
                    
                    if (selectedSlots.includes(key)) {
                        selectedSlots = selectedSlots.filter(s => s !== key);
                        this.classList.remove('bg-blue-300');
                        this.classListthis.classList.add('bg-green-100', 'hover:bg-green-200');
                        this.textContent = '○';
                    } else {
                        if (selectedSlots.length >= 3) {
                            alert('選択できるのは最大3つまでです');
                            return;
                        }
                        selectedSlots.push(key);
                        this.classList.remove('bg-green-100', 'hover:bg-green-200');
                        this.classList.add('bg-blue-300');
                        this.textContent = '✓';
                    }
                    
                    localStorage.setItem('studentSelectedSlots', JSON.stringify(selectedSlots));
                });
            });
        }

        // ==========================================
        // Manual Assignment
        // ==========================================
        
        window.openManualAssign = async function(studentId) {
            const students = await getFromFirebase('students') || {};
            const student = students[studentId];
            if (!student) return alert('生徒が見つかりません');

            showTeacherTab('manualAssign');

            // Select the student
            const select = document.getElementById('manualStudentSelect');
            if (select) {
                select.value = student.email;
            }
        };

        // ==========================================
        // Helper Functions
        // ==========================================
        
        function getNextDate(dayName) {
            const days = {
                '日': 0, '月': 1, '火': 2, '水': 3, '木': 4, '金': 5, '土': 6
            };
            const today = new Date();
            const targetDay = days[dayName];
            const todayDay = today.getDay();
            const daysUntilTarget = (targetDay - todayDay + 7) % 7 || 7;
            
            const targetDate = new Date(today);
            targetDate.setDate(today.getDate() + daysUntilTarget);
            
            return targetDate.toISOString().split('T')[0];
        }

        async function loadMakeupTimeOptions() {
            const select = document.getElementById('makeupToTime');
            const dateInput = document.getElementById('makeupToDate');

            if (!select || !dateInput) return;

            select.innerHTML = '<option value="">時間選択</option>';

            const teacherSchedule = await getFromFirebase('teacherSchedule') || {};
            const daySelect = dateInput.value;
            if (!daySelect) return;

            const day = new Date(daySelect).getDay();
            const dayNames = ['日','月','火','水','木','金','土'];
            const dayName = dayNames[day];

            for (let hour = 9; hour <= 20; hour++) {
                for (let minute = 0; minute < 60; minute += 30) {
                    const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    const endHour = minute === 30 ? hour + 1 : hour;
                    const endMinute = minute === 30 ? 0 : 30;
                    const endTimeStr = `${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`;

                    const key = `${dayName}_${timeStr}`;
                    if (teacherSchedule[key] === true) {
                        const opt = document.createElement('option');
                        opt.value = timeStr;
                        opt.textContent = `${timeStr} - ${endTimeStr}`;
                        select.appendChild(opt);
                    }
                }
            }
        }

        function populateManualTimeOptions() {
            const select = document.getElementById('manualTime');
            if (!select) return;

            select.innerHTML = '<option value="">時間を選択</option>';

            for (let hour = 9; hour <= 20; hour++) {
                for (let minute = 0; minute < 60; minute += 30) {
                    const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    const endHour = minute === 30 ? hour + 1 : hour;
                    const endMinute = minute === 30 ? 0 : 30;
                    const endTimeStr = `${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`;

                    const opt = document.createElement('option');
                    opt.value = timeStr;
                    opt.textContent = `${timeStr} - ${endTimeStr}`;
                    select.appendChild(opt);
                }
            }
        }

        async function populateManualStudentOptions() {
            const select = document.getElementById('manualStudentSelect');
            if (!select) return;

            const students = await getFromFirebase('students') || {};
            select.innerHTML = '<option value="">生徒を選択</option>';

            Object.values(students).forEach(student => {
                const opt = document.createElement('option');
                opt.value = student.email;
                opt.textContent = `${student.name}（${student.email}）`;
                select.appendChild(opt);
            });
        }
    </script>
</body>
</html>
